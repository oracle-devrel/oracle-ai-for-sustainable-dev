<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive AI Hologram With Oracle Database</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/css/bootstrap.min.css"
          crossorigin="anonymous">
    <style>
        body {
            text-align: center;
            padding: 20px;
            background-color: #2A2F2F;
            color: #F1EFED;
        }
        h1, p, label {
            color: #F1EFED;
        }
        #transcription {
            color: #000000;
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background: white;
            width: 50%;
            margin-left: auto;
            margin-right: auto;
            min-height: 100px;
            max-width: 400px;
            overflow-y: auto;
            text-align: left;
        }
        button {
            margin-top: 10px;
            color: #F1EFED;
        }
        .radio-group {
            margin-top: 15px;
            text-align: left;
        }
        .radio-group label {
            display: block;
            margin-bottom: 5px;
        }
        .flags {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .flags img {
            width: 30px;
            height: 20px;
            margin-left: 5px;
        }
        .bottom-links {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .bottom-links a {
            margin: 0 10px;
        }
        .bottom-links img {
            width: 200px;
            height: auto;
        }
    </style>
</head>
<body>

<!-- Language selection -->
<div class="flags">
    <a href="aiholo?languageCode=he-IL"><img src="../images-aiholo/Flags/he-IL.svg" alt="Hebrew"></a>
    <a href="aiholo?languageCode=de-DE"><img src="../images-aiholo/Flags/de-DE.svg" alt="German"></a>
    <a href="aiholo?languageCode=es-MX"><img src="../images-aiholo/Flags/es-MX.svg" alt="Spanish (Mexico)"></a>
    <a href="aiholo?languageCode=hi-IN"><img src="../images-aiholo/Flags/hi-IN.svg" alt="Hindi (India)"></a>
    <a href="aiholo?languageCode=pt-BR"><img src="../images-aiholo/Flags/pt-BR.svg" alt="Portuguese"></a>
    <a href="aiholo?languageCode=es-ES"><img src="../images-aiholo/Flags/es-ES.svg" alt="Spanish"></a>
    <a href="aiholo?languageCode=zh-SG"><img src="../images-aiholo/Flags/zh-SG.svg" alt="Chinese (Singapore)"></a>
    <a href="aiholo?languageCode=it-IT"><img src="../images-aiholo/Flags/it-IT.svg" alt="Italian"></a>
    <a href="aiholo?languageCode=en-GB"><img src="../images-aiholo/Flags/en-GB.svg" alt="English (GB)"></a>
    <a href="aiholo?languageCode=ar-ae"><img src="../images-aiholo/Flags/ar-AE.svg" alt="Arabic-UAE"></a>
    <a href="aiholo?languageCode=ja-JP"><img src="../images-aiholo/Flags/ja-JP.svg" alt="Japanese"></a>
    <a href="aiholo?languageCode=fr-FR"><img src="../images-aiholo/Flags/fr-FR.svg" alt="France"></a>
    <a href="aiholo?languageCode=ga-IE"><img src="../images-aiholo/Flags/ga-GA.svg" alt="Ireland"></a>
    <a href="aiholo?languageCode=ro-RO"><img src="../images-aiholo/Flags/ro-RO.svg" alt="Romania"></a>
    <a href="aiholo?languageCode=en-AU"><img src="../images-aiholo/Flags/en-AU.svg" alt="Australia"></a>
    <a href="aiholo?languageCode=en-US"><img src="../images-aiholo/Flags/en-US.svg" alt="English (United States)"></a>

    &nbsp;Current:
    <img th:src="@{'/images-aiholo/Flags/' + ${languageCode} + '.svg'}"
         th:alt="${languageCode}"
         style="width: 30px; height: 20px;">
</div>

<br><br>
<h2>Interactive AI Holograms With Oracle Database</h2>
<h5>Ask the hologram a question and get a reply!</h5>
<h65>For Example, "what is the latest version of the Oracle database?" or "what are some features of the latest Oracle Database?"</h65>

<!-- âœ… Correctly sets languageCodeSTT for STT using Thymeleaf -->
<script th:inline="javascript">
    var languageCodeSTT = /*[[${languageCode} ?: 'pt-BR']]*/ 'pt-BR';
    var voiceName = /*[[${voiceName} ?: 'pt-BR-Wavenet-D']]*/ 'pt-BR-Wavenet-D';
    console.log("Using Speech Recognition Language: " + languageCodeSTT + " and VoiceName: " + voiceName);
    console.log("Speech Recognition Language Code:", languageCodeSTT);
</script>

<div class="container mt-3">
    <div class="row text-left">
        <div class="col-md-4">
            <p>1. Select one...</p>
            <div class="radio-group">
                <label><input type="radio" name="mode" value="use chat" checked>ask LLM directly</label>
<!--                <label><input type="radio" name="mode" value="use narrate">narrate: to use Select AI</label>-->
                <label><input type="radio" name="mode" value="use vector">use Select AI and RAG with vector search</label>
            </div>
        </div>
        <div class="col-md-4">
            <p>2. Click the mic below and speak your question.<br>&nbsp;&nbsp;&nbsp;&nbsp;(Click the trash bin to clear the textfield)</p>
            <button id="startBtn" class="btn btn-primary" style="background: none; border: none; padding: 0;">
                <img src="../images-aiholo/Icons/Yellow/Microphone.svg" alt="Start" style="width: 70px; height: auto;">
            </button>
            <button id="clearBtn" class="btn btn-primary" style="background: none; border: none; padding: 0;">
                <img src="../images-aiholo/Icons/Yellow/Trash bin.svg" alt="Clear" style="width: 70px; height: auto;">
            </button>
        </div>
        <div class="col-md-4">
            <p>3. Click stop button to send your question.</p>
            <button id="stopSendBtn" class="btn btn-primary" style="background: none; border: none; padding: 0;">
                <img src="../images-aiholo/Icons/Yellow/Stop recording.svg" alt="Stop" style="width: 70px; height: auto;">
            </button>
        </div>
    </div>
</div>

<!-- âœ… Transcription field restored -->
<div id="transcription"></div>
<p id="responseMessage"></p>

<!-- Button Row: Mirror Me, Single Button Mode, Explain This -->
<div class="d-flex justify-content-center align-items-center" style="gap: 40px; margin-top: 30px; margin-bottom: 30px;">
    <!-- Mirror Me Button -->
    <div>
        <p style="margin-bottom: 8px;">Mirror Me</p>
        <button id="mirrorMeBtn" class="btn btn-primary" style="background: none; border: none; padding: 0;">
            <img src="../images-aiholo/Icons/Yellow/Face id.svg" alt="Mirror Me" style="width: 70px; height: auto;">
        </button>
    </div>
    <!-- Single Button Mode Button -->
    <div>
        <p style="margin-bottom: 8px;">Single Button Mode</p>
        <button id="singleBtnMode" class="btn btn-primary" style="background: none; border: none; padding: 0;">
            <img id="singleBtnIcon" src="../images-aiholo/Icons/Yellow/Microphone.svg" alt="Single Button Mode" style="width: 70px; height: auto;">
        </button>
    </div>
    <!-- Explainer Button -->
    <div>
        <p style="margin-bottom: 8px;">Explain Exhibit</p>
        <button id="explainerBtn" class="btn btn-primary" style="background: none; border: none; padding: 0;">
            <img src="../images-aiholo/Icons/Yellow/Explain.svg" alt="Explain This" style="width: 70px; height: auto;">
        </button>
    </div>
</div>

<hr style="border-top: 2px solid #CC5500; margin: 20px 0;">
<br>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("Speech Recognition Language Code:", languageCodeSTT);
        let recognition;
        let isListening = false;
        let transcriptBuffer = "";
        let conversationHistory = []; // Array to store the last two questions and answers

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = languageCodeSTT;

            recognition.onstart = () => {
                console.log("ðŸŽ¤ Speech recognition started with language:", recognition.lang);
                document.getElementById("startBtn").disabled = true;
                document.getElementById("stopSendBtn").disabled = false;
                transcriptBuffer = "";
                isListening = true;
            };

            recognition.onend = () => {
                console.log("ðŸ›‘ Speech recognition stopped.");
                document.getElementById("startBtn").disabled = false;
                document.getElementById("stopSendBtn").disabled = true;
                isListening = false;
            };

            recognition.onerror = (event) => {
                console.error("âš ï¸ Error:", event.error);
            };

            recognition.onresult = (event) => {
                let interimTranscript = "";
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcriptBuffer += event.results[i][0].transcript + " ";
                    } else {
                        interimTranscript += event.results[i][0].transcript + " ";
                    }
                }
                console.log("Final Transcript Buffer:", transcriptBuffer.trim());
                console.log("Interim Transcript:", interimTranscript.trim());
                document.getElementById("transcription").innerText = transcriptBuffer.trim() + " " + interimTranscript.trim();
            };
        } else if (recognition.lang !== "he-IL" && languageCodeSTT === "he-IL") {
            alert("âš ï¸ Speech Recognition for specified language is not supported in this browser.");
        } else {
            alert("âš ï¸ Browser does not support Speech Recognition.");
        }

        document.getElementById("startBtn").addEventListener("click", () => {
            if (!isListening) recognition.start();
        });

        // Extract send logic to a function
        async function sendTranscript() {
            const transcriptionText = transcriptBuffer.trim();
            if (!transcriptionText) {
                alert("âš ï¸ No text captured. Try sending again.");
                return;
            }

            // Add the current question to the conversation history
            conversationHistory.push({ question: transcriptionText });

            // Keep only the last two questions and answers
            if (conversationHistory.length > 2) {
                conversationHistory.shift();
            }

            // Build the conversational context
            let conversationalContext = conversationHistory
                .map((entry, index) => `Q${index + 1}: ${entry.question}${entry.answer ? `\nA${index + 1}: ${entry.answer}` : ''}`)
                .join('\n');

            const selectedMode = document.querySelector('input[name="mode"]:checked').value;
            const modifiedText = `${conversationalContext}\nQ: ${transcriptionText}`;
            const apiUrl = `https://aiholo.org/aiholo/play?question=${encodeURIComponent(modifiedText)}&selectedMode=${encodeURIComponent(selectedMode)}&languageCode=${encodeURIComponent(languageCodeSTT)}&voiceName=${encodeURIComponent(voiceName)}`;

            try {
                const response = await fetch(apiUrl, { method: "GET" });
                const result = await response.text();

                // Add the response to the last question in the conversation history
                conversationHistory[conversationHistory.length - 1].answer = result;

                document.getElementById("responseMessage").innerText = `âœ… Response: ${result}`;
                document.getElementById("stopSendBtn").disabled = false;

                // Check for the specific error string in the result
                if (typeof result === "string" && result.includes("com.google.api.gax.rpc.UnavailableException: io.grpc.StatusRuntimeException: UNAVAILABLE: Credentials failed to obtain metadata")) {
                    fetch("https://aiholo.org/aiholo/credentialfailed", { method: "GET" });
                }
            } catch (error) {
                document.getElementById("responseMessage").innerText = "âŒ Error retrieving response.";
            } finally {
                // Always clear transcript buffer and field after sending
                transcriptBuffer = "";
                document.getElementById("transcription").innerText = "";
            }
        }

        document.getElementById("stopSendBtn").addEventListener("click", async () => {
            if (isListening) recognition.stop();
            await sendTranscript();
        });

        // Add event listener for the Clear button
        document.getElementById("clearBtn").addEventListener("click", () => {
            console.log("Clear button clicked!"); // Debugging
            transcriptBuffer = ""; // Clear the transcript buffer
            document.getElementById("transcription").innerText = ""; // Clear the transcription text field
            document.getElementById("responseMessage").innerText = ""; // Optionally clear the response message
            conversationHistory = []; // Clear the conversation history
        });

        // Add event listener for the Mirror Me button
        document.getElementById("mirrorMeBtn").addEventListener("click", async () => {
            try {
                const response = await fetch("https://aiholo.org/aiholo/set?value=mirrorme", { method: "GET" });
                if (response.ok) {
                    alert("âœ… Switched to 'Mirror Me' mode successfully!");
                } else {
                    alert("âŒ Failed to switch to 'Mirror Me' mode.");
                }
            } catch (error) {
                console.error("Error switching to 'Mirror Me' mode:", error);
                alert("âŒ An error occurred while switching to 'Mirror Me' mode.");
            }
        });

        // Add event listener for the Explainer button
        document.getElementById("explainerBtn").addEventListener("click", async () => {
            try {
                const response = await fetch("https://aiholo.org/aiholo/explainer", { method: "GET" });
                if (response.ok) {
                    alert("âœ… Explainer mode activated successfully!");
                } else {
                    alert("âŒ Failed to activate explainer mode.");
                }
            } catch (error) {
                console.error("Error activating explainer mode:", error);
                alert("âŒ An error occurred while activating explainer mode.");
            }
        });

        // Single Button Mode toggle logic
        let singleBtnModeState = false; // false = ready to start, true = ready to stop

        const singleBtnMode = document.getElementById("singleBtnMode");
        const singleBtnIcon = document.getElementById("singleBtnIcon");
        const micIcon = "../images-aiholo/Icons/Yellow/Microphone.svg";
        const stopIcon = "../images-aiholo/Icons/Yellow/Stop recording.svg";

        singleBtnMode.addEventListener("click", () => {
            if (!singleBtnModeState) {
                // Start recognition
                if (!isListening) recognition.start();
                singleBtnIcon.src = stopIcon;
                singleBtnModeState = true;
                singleBtnMode.disabled = false;
            } else {
                // Stop recognition (always call stop, let onend handle the rest)
                recognition.stop();
                singleBtnMode.disabled = true; // Prevent double clicks
                // Only clear the display for feedback, NOT the buffer!
                document.getElementById("transcription").innerText = "";
            }
        });

        if (recognition) {
            recognition.onstart = () => {
                singleBtnIcon.src = stopIcon;
                singleBtnModeState = true;
                singleBtnMode.disabled = false;
            };
            recognition.onend = async () => {
                singleBtnIcon.src = micIcon;
                singleBtnModeState = false;
                singleBtnMode.disabled = false;
                await sendTranscript(); // Always call, will handle empty transcript
                transcriptBuffer = "";
                document.getElementById("transcription").innerText = "";
            };
        }
    });
</script>

<!--<div class="bottom-links">-->
<br>
<div>
    <a href="https://bit.ly/3AdlZ1d" target="_blank">
        <img src="../images-aiholo/refarchdesktopversion.png" alt="ai holo arch" style="width: 1000px; height: auto;">
    </a>
    <br>
    <br>
    <a href="https://bit.ly/3AdlZ1d" target="_blank">
        <img src="../images-aiholo/ODTdesktopversion.png" alt="Oracle Database" style="width: 1000px; height: auto;">
    </a>
    <br>
    <br>
    <a href="https://bit.ly/3AdlZ1d" target="_blank">
        <img src="../images-aiholo/bit.ly_interactive-ai-holograms.png" alt="aiholo repos" style="width: 400px; height: auto;">
    </a>
</div>
<br>
<hr style="border-top: 2px solid #CC5500; margin: 20px 0;">
<br>
<div class="footer">
    <div class="input-group">
        <input type="text" id="speechInput" class="form-control" placeholder="Type something to say directly...">
        <div class="input-group-append">
            <img src="../images-aiholo/Icons/Yellow/Stop recording.svg" onclick="submitQuery()" style="cursor:pointer;">
        </div>
    </div>
</div>

<script>
    function submitQuery() {
        var inputVal = document.getElementById('speechInput').value;
        var url = 'https://aiholo.org/aiholo/saything?whattosay=' + encodeURIComponent(inputVal);
        window.open(url, '_blank');
    }
</script>

</body>
</html>
